#!/usr/bin/env lua
-- get-bao-secret.lua — Fetch a KV secret from OpenBao
-- Usage: sudo lua get-bao-secret.lua kv/data/terra/app

local BAO_ADDR = "https://secrets.wirecrop.net"
local TOKEN_FILE = "/etc/credentials/openbao-token"

local function command_exists(cmd)
  local handle = io.popen("command -v " .. cmd .. " 2>/dev/null")
  if handle == nil then
    io.stderr:write(string.format("failed to check if %s exists could not create shell", cmd))
    os.exit(1)
  end
  local result = handle:read("*l")
  handle:close()
  return result ~= nil and result ~= ""
end

-- dependency checks
if not command_exists("curl") then
  io.stderr:write("Error: curl is not installed - run: sudo apt install curl\n")
  os.exit(1)
end

if not command_exists("jq") then
  io.stderr:write("Error: jq is not installed - run: sudo apt install jq\n")
  os.exit(1)
end

local path = arg[1]
if not path then
  io.stderr:write("Usage: sudo lua get-bao-secret.lua <path>\n")
  io.stderr:write("Example: sudo lua get-bao-secret.lua kv/data/terra/app\n")
  os.exit(1)
end

-- Read the token
local token_fh = io.open(TOKEN_FILE, "r")
if not token_fh then
  io.stderr:write("Error: could not open " .. TOKEN_FILE .. " — try running with sudo\n")
  os.exit(1)
end
local token = token_fh:read("*l")
token_fh:close()

if not token or token == "" then
  io.stderr:write("Error: token file is empty\n")
  os.exit(1)
end

-- build the curl command
local url = BAO_ADDR .. "/v1/" .. path
local cmd = string.format(
  'curl -s -w "\\n%%{http_code}" --header "X-Vault-Token: %s" "%s"',
  token, url
)

-- execute and capture output
local handle = io.popen(cmd)
if handle == nil then
  io.stderr:write(string.format("failed to execute: %s", cmd))
  os.exit(1)
end
local result = handle:read("*a")
handle:close()

-- split body and HTTP status code (last line)
local body, http_code = result:match("^(.*)\n(%d%d%d)$")

if not http_code then
  io.stderr:write("Error: could not reach OpenBao at " .. BAO_ADDR .. "\n")
  os.exit(1)
end

http_code = tonumber(http_code)

if http_code == 0 then
  io.stderr:write("Error: could not connect to OpenBao — is it down?\n")
  os.exit(1)
end

if http_code ~= 200 then
  io.stderr:write("Error: OpenBao returned HTTP " .. http_code .. "\n")
  io.stderr:write(body .. "\n")
  os.exit(1)
end

-- Parse and print KEY=VALUE pairs using jq
local jq_cmd = string.format(
  'echo %q | jq -r \'.data.data | to_entries[] | "\\(.key)=\\(.value)"\'',
  body
)
local jq_handle = io.popen(jq_cmd)
if jq_handle == nil then
  io.stderr:write(string.format("failed to run jq: %s", jq_cmd))
  os.exit(1)
end
local output = jq_handle:read("*a")
jq_handle:close()

if not output or output == "" then
  io.stderr:write("Error: no data found at path: " .. path .. "\n")
  os.exit(1)
end

io.write(output)
