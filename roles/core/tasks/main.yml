- name: ensure locale is set to {{ config_system_locale }}
  import_tasks: locale.yml

# packages
- name: Execute Jinja2 script on remote host
  raw: |
    {% for package in packages %}
     dpkg-query -s "{{ package }}" > /dev/null 2>&1
     if [ $? -ne 0 ]; then
       apt-get install -y "{{ package }}" > /dev/null 2>&1
       echo "NEW PACKAGE INSTALLED: {{ package }}"
     else
       echo {{ package }} is already installed
     fi
    {% endfor %}
  register: pkg_result
  changed_when: '"PACKAGE INSTALLED" in pkg_result.stdout'

- name: Debug package results
  debug:
    msg: "{{ item }}"
  loop: "{{ pkg_result.stdout_lines }}"

# zshell
- name: set zsh to be the default shell
  user:
    name: '{{username}}'
    shell: /usr/bin/zsh

# enable pcspkr device for roland
# allows access to /dev/input/by-path/platform-pcspkr-event-spkr
- name: add '{{username}}' to group realtime
  user:
    name: '{{username}}'
    groups: input
    append: yes

- name: check if dotfiles directory exists
  stat:
    path: '/home/{{username}}/.gnupg'
  register: gnupg_stat

# copy over the gpg config file
- name: ensure gnupg dir created in home directory
  file:
    path: '/home/{{username}}/.gnupg'
    state: directory
    mode: '0700'
    owner: '{{username}}'
    group: '{{username}}'
  when: gnupg_stat.stat.exists

- name: copy gpg-agent.conf to gnupg directory
  copy:
    src: ./gpg-agent.conf
    dest: '/home/{{username}}/.gnupg/gpg-agent.conf'
    owner: 'root'
    group: 'root'
    mode: 0644
    force: yes
